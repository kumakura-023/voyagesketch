# VoyageSketch 再構築マスタープロンプト

## プロジェクト概要

**VoyageSketch**は旅行計画作成のためのリアルタイム共同編集可能なマップアプリケーションです。複雑化した既存実装を0から再構築し、**保守性の高い**、**最適化された**アプリケーションを目指します。

### 再構築の主要目的

1. **メモ機能の同期問題の根本的解決**（最重要）
2. **複雑性の軽減と保守性の向上**
3. **パフォーマンスの最適化**
4. **コードの可読性と拡張性の改善**

## アーキテクチャ設計原則

### 1. レイヤード・アーキテクチャ（簡素化版）

```
┌─────────────────────────────────────┐
│           UI Layer (React)          │ ← コンポーネント、フック
├─────────────────────────────────────┤
│       Application Layer             │ ← ビジネスロジック、ストア
├─────────────────────────────────────┤
│       Infrastructure Layer          │ ← 外部API、データベース
└─────────────────────────────────────┘
```

### 2. 状態管理の明確な分離

- **UI状態**: 即座反映用（ローカル）
- **ドメイン状態**: アプリケーション状態
- **同期状態**: クラウド同期管理

### 3. 同期システムの根本的見直し

**現在の問題解決アプローチ:**
- 単一責任の同期マネージャー
- 操作ベースの競合解決
- UI状態とクラウド状態の完全分離

## 技術スタック（継続使用）

### フロントエンド
- **React 18** + **TypeScript** + **Vite**
- **Tailwind CSS**（デザインシステム継続）
- **Zustand**（シンプル化）

### バックエンド・データ
- **Firebase/Firestore**（リアルタイム同期）
- **Google Maps API**（地図・場所・ルート）

### PWA・ビルド
- **vite-plugin-pwa** + **Workbox**

## ディレクトリ構造

```
src/
├── components/           # UIコンポーネント（機能別分割）
│   ├── map/             # 地図関連
│   ├── places/          # 場所管理
│   ├── plans/           # 計画管理
│   ├── routes/          # ルート管理
│   ├── memo/            # メモ機能（独立）
│   └── shared/          # 共通コンポーネント
├── hooks/               # カスタムフック（機能別）
│   ├── map/
│   ├── places/
│   ├── plans/
│   └── sync/            # 同期専用フック
├── stores/              # Zustandストア（機能別分割）
│   ├── mapStore.ts
│   ├── placesStore.ts
│   ├── plansStore.ts
│   └── syncStore.ts     # 同期状態管理
├── services/            # ビジネスロジック
│   ├── sync/            # 同期システム（専用ディレクトリ）
│   ├── api/             # API連携
│   └── core/            # コアサービス
├── types/               # 型定義
└── utils/               # ユーティリティ
```

## 重要な設計決定

### 1. メモ機能の同期問題解決策

#### A. 状態の明確な分離
```typescript
// UI状態（即座反映）
const [localMemo, setLocalMemo] = useState('');

// 同期状態（デバウンス後にクラウド反映）
const syncMemo = useMemoSync(placeId);

// 競合解決
const resolvedMemo = useConflictResolution(localMemo, syncMemo);
```

#### B. 操作ベースの同期
```typescript
interface SyncOperation {
  id: string;
  type: 'memo_update' | 'place_add' | 'plan_update';
  userId: string;
  timestamp: number;
  data: any;
}
```

#### C. 単一責任の同期マネージャー
- **責任**: クラウド同期のみ
- **除外**: UI状態管理、リアルタイム更新の処理

### 2. パフォーマンス最適化

#### A. コンポーネント分割
- 機能ごとに独立したコンポーネント
- メモ化とlazy loadingの適切な使用
- 不要な再レンダリングの防止

#### B. バンドル最適化
- 機能別のcode splitting
- 地図APIの遅延読み込み
- 使用頻度に基づくチャンク分割

### 3. エラーハンドリング

#### A. 段階的エラー処理
```typescript
// Level 1: UI通知
// Level 2: 自動リトライ
// Level 3: オフラインモード切り替え
// Level 4: データ復旧
```

#### B. オフライン対応
- Service Workerによるオフライン機能
- データの楽観的更新
- 接続復旧時の自動同期

## 実装順序（推奨）

### Phase 1: 基盤構築（1-2週間）
1. プロジェクト初期化とボイラープレート
2. 基本的なルーティングとレイアウト
3. ストア構造の構築
4. 型定義の整備

### Phase 2: コア機能（2-3週間）
1. 地図表示と基本操作
2. 場所の追加・表示・管理
3. 基本的な計画作成・編集

### Phase 3: 同期システム（1-2週間）
1. **新しい同期システムの構築**
2. **メモ機能の実装（問題解決版）**
3. リアルタイム更新の実装

### Phase 4: 高度な機能（2-3週間）
1. ルート計算・表示
2. コスト管理
3. 共有・招待機能

### Phase 5: 仕上げ・最適化（1週間）
1. PWA機能の実装
2. パフォーマンス最適化
3. テスト・デバッグ

## 品質保証

### 開発時の必須チェック
1. **TypeScript型チェック**: `npm run type-check`
2. **ESLint**: `npm run lint`
3. **手動テスト**: 各機能の動作確認
4. **同期テスト**: 複数ブラウザでの同時編集テスト

### パフォーマンス指標
- **First Contentful Paint**: < 1.5s
- **Largest Contentful Paint**: < 2.5s
- **メモ同期遅延**: < 500ms
- **地図読み込み**: < 3s

## 成功指標

### 機能面
- [ ] メモ機能で無限ループが発生しない
- [ ] リアルタイム同期が正常動作する
- [ ] 複数ユーザーでの同時編集が可能
- [ ] オフライン機能が動作する

### 技術面
- [ ] バンドルサイズが現在より20%以上削減
- [ ] パフォーマンス指標をすべて満たす
- [ ] TypeScriptエラーが0件
- [ ] ESLintエラーが0件

## 実装支援

各機能の詳細な実装指示は、別ファイルで提供します：

- `REBUILD_01_FOUNDATION.md` - 基盤構築
- `REBUILD_02_MAP_PLACES.md` - 地図・場所機能
- `REBUILD_03_SYNC_MEMO.md` - 同期・メモ機能
- `REBUILD_04_PLANS_ROUTES.md` - 計画・ルート機能
- `REBUILD_05_ADVANCED.md` - 高度な機能
- `REBUILD_06_OPTIMIZATION.md` - 最適化・仕上げ

---

**重要**: このマスタープロンプトに従って段階的に実装することで、現在の問題を根本的に解決し、保守性の高いアプリケーションを構築できます。特にメモ機能の同期問題は、状態の分離と操作ベースの同期により確実に解決されます。